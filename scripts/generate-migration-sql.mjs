#!/usr/bin/env node

/**
 * Generate a single SQL file with all pending migrations
 * Output: combined-migrations.sql
 */

import { readFileSync, readdirSync, writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const MIGRATIONS_DIR = join(__dirname, '../supabase/migrations');
const OUTPUT_FILE = join(__dirname, '../combined-migrations.sql');

const files = readdirSync(MIGRATIONS_DIR)
  .filter(f => f.endsWith('.sql'))
  .filter(f => f !== '000_create_migration_tracking.sql') // Skip tracking table
  .sort();

console.log(`ğŸ“‹ Found ${files.length} migrations to combine\n`);

let combinedSQL = `-- Combined Migrations
-- Generated: ${new Date().toISOString()}
-- Auto-generated by: npm run generate-migrations

`;

for (const file of files) {
  const filePath = join(MIGRATIONS_DIR, file);
  const sql = readFileSync(filePath, 'utf-8');

  combinedSQL += `\n`;
  combinedSQL += `-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
  combinedSQL += `-- Migration: ${file}\n`;
  combinedSQL += `-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
  combinedSQL += sql;
  combinedSQL += `\n\n-- Mark as applied\n`;
  combinedSQL += `INSERT INTO schema_migrations (version) VALUES ('${file}');\n`;
  combinedSQL += `\n`;

  console.log(`âœ“ Added: ${file}`);
}

writeFileSync(OUTPUT_FILE, combinedSQL, 'utf-8');

console.log(`\nâœ¨ Generated: ${OUTPUT_FILE}`);
console.log(`\nğŸ“‹ Next steps:`);
console.log(`   1. Open: ${OUTPUT_FILE}`);
console.log(`   2. Copy all the SQL`);
console.log(`   3. Go to: https://supabase.com/dashboard/project/gmhrjszytqslojujpvws/sql/new`);
console.log(`   4. Paste and run!\n`);